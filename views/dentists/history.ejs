<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ประวัติการรักษา: <%= patient.first_name %> | Dentaist Clinic System</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"> 
  <link rel="stylesheet" href="/public/css/styles.css"/> 
  <link rel="stylesheet" href="/public/css/history-custom.css"/> 
</head>
<body data-user-role="<%= userRole %>">

  <div id="success-alert" class="alert alert-success alert-dismissible fade show" role="alert"
       style="display: none; position: fixed; top: 80px; right: 20px; z-index: 1050;">
    <div id="success-alert-message"></div>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="patient-name-header"><%= patient.first_name %> <%= patient.last_name %></h3>
        <div class="patient-info-chips">
          <span class="chip">CN: <%= patient.clinic_number %></span>
          <span class="chip">อายุ: <%= patient.age %> ปี</span>
          <span class="chip">เพศ: <%= patient.gender %></span>
        </div>
      </div>
      <div>
        <% if (userRole === 'dentist') { %>
          <a href="/dentist/new/<%= patient.id %>" class="btn btn-primary">+ บันทึกการรักษา</a>
          <a href="/dentist/patients" class="btn btn-secondary">กลับไปหน้ารายชื่อ</a>
        <% } %>
        <% if (userRole === 'staff') { %>
          <a href="/staff/<%= patient.id %>/edit" class="btn btn-warning">แก้ไขข้อมูลคนไข้</a>
          <a href="/staff/patients" class="btn btn-secondary">กลับไปหน้ารายชื่อ</a>
        <% } %>
      </div>
    </div>

    <div class="main-content">
      <!-- Left Panel: List -->
      <div class="panel list-panel">
        <div class="history-toolbar">
          <div class="search-wrapper">
            <i class="fa-solid fa-magnifying-glass" style="color: var(--text-muted)"></i>
            <input type="search" id="search-input" placeholder="ค้นหา (แพทย์/หัตถการ/หมายเหตุ)">
          </div>
          <div class="date-group">
            <label for="start-date-input">จาก</label>
            <input type="date" id="start-date-input">
          </div>
          <div class="date-group">
            <label for="end-date-input">ถึง</label>
            <input type="date" id="end-date-input">
          </div>
        </div>

        <!-- ทำคอนเทนเนอร์เลื่อนให้ฝั่งซ้าย -->
        <div class="visit-scroll">
          <div class="visit-list-header">
            <div>วันที่ / เวลา</div>
            <div>หัตถการ / สรุป</div>
            <div>ทันตแพทย์</div>
            <div>สถานะ</div>
          </div>

          <div class="visit-list-body" id="visit-list-body">
            <% if(visits.length > 0) { %>
              <% visits.forEach((visit, index) => { 
                const doctorName = visit.doctor_name || 'N/A';
                const clinicalNotes = visit.clinical_notes || '';
                const proceduresSummary = visit.procedure_list[0].description || '-';
                const searchText = (doctorName + ' ' + clinicalNotes + ' ' + proceduresSummary).toLowerCase();
              %> 
                <a href="#" class="visit-item <%= index === 0 ? 'active' : '' %>" 
                   data-visit-id="<%= visit.id %>"
                   data-search-text="<%= searchText %>"
                   data-visit-date-iso="<%= new Date(visit.visit_date).toISOString().split('T')[0] %>">
                  <div><%= new Date(visit.visit_date).toLocaleString('sv-SE', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(' ', ' ') %></div>
                  <div><%= proceduresSummary %></div>
                  <div><%= doctorName %></div>
                  <div>
                    <span class="badge <%= visit.payment_status === 'ชำระแล้ว' ? 'badge-success' : 'badge-warning' %>">
                      <%= visit.payment_status %>
                    </span>
                  </div>
                </a>
              <% }); %>
            <% } else { %>
              <div class="text-center p-4 text-muted">ไม่มีประวัติการรักษา</div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Right Panel: Details -->
      <div class="panel detail-panel">
        <!-- ทำคอนเทนเนอร์เลื่อนให้ฝั่งขวา -->
        <div class="detail-scroll">
          <div class="detail-panel-header" id="detail-header">รายละเอียดการรักษา</div>
          <div class="detail-content" id="detail-content">
            <!-- Details populated by script -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <script type="application/json" id="visits-data">
    <%- JSON.stringify(visits) %>
  </script>

  <script nonce="<%= locals.nonce %>">
document.addEventListener('DOMContentLoaded', function() {
  const visitsDataElement = document.getElementById('visits-data');
  const allVisitsData = JSON.parse(visitsDataElement.textContent);
  const visitsMap = new Map(allVisitsData.map(v => [v.id.toString(), v]));

  const visitListBody = document.getElementById('visit-list-body');
  const detailHeader = document.getElementById('detail-header');
  const detailContent = document.getElementById('detail-content');

  function updateDetails(visitId) {
    const visit = visitsMap.get(visitId);
    if (!visit) {
      detailHeader.textContent = 'รายละเอียดการรักษา';
      detailContent.innerHTML = `<div class="detail-content-empty">เลือกรายการจากด้านซ้ายเพื่อดูรายละเอียด</div>`;
      return;
    }

    // แปลงวันที่ให้ดูสวย
    const visitDateFormatted = new Date(visit.visit_date).toLocaleString('th-TH', {
      year: 'numeric', month: 'long', day: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
    detailHeader.textContent = `รายละเอียด (${visitDateFormatted})`;

    // ✅ ใช้ field ตาม RDS: procedure_list, notes, status, payment_amount, payment_status
    let contentHtml = `
      <div class="detail-section"><h5>หัตถการ</h5><p>${visit.procedure_list[0].description || 'ไม่มีข้อมูล'}</p></div>
      <div class="detail-section"><h5>Vital Signs</h5>
        <p>BP SYS: ${visit.vital_signs.bp_sys} | BP DIA: ${visit.vital_signs.bp_dia} | PULSE : ${visit.vital_signs.pulse_rate}</p>
      <div class="detail-section"><h5>บันทึก / ข้อสังเกต </h5>
         <p>${visit.notes || 'ไม่มีบันทึก'}</p></div>
        <div class="detail-section"><h5>X-RAYS</h5>
    `;

    // ✅ ส่วนการชำระเงิน
    let paymentHtml = `
      <div class="detail-section"><h5><i class="fas fa-file-invoice-dollar"></i> การชำระเงิน</h5>
        <p>
          <strong>สถานะ:</strong> 
          <span class="badge ${
            visit.payment_status === 'paid' ? 'badge-success' :
            visit.payment_status === 'pending' ? 'badge-warning' :
            'badge-secondary'
          }">${visit.payment_status || '-'}</span><br>
          <strong>จำนวนเงิน:</strong> ${(visit.payment_amount || 0).toLocaleString('th-TH')} บาท<br>
          <strong>วันที่ชำระ:</strong> ${visit.payment_date ? new Date(visit.payment_date).toLocaleDateString('th-TH') : '-'}
        </p>
      </div>
    `;

    detailContent.innerHTML = contentHtml + paymentHtml;
  }

  // ───────────── Event: คลิกรายการฝั่งซ้าย ─────────────
  document.getElementById('visit-list-body').addEventListener('click', function(e) {
    const item = e.target.closest('.visit-item');
    if (!item) return;
    e.preventDefault();
    this.querySelectorAll('.visit-item').forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    updateDetails(item.dataset.visitId);
  });

  // ───────────── เริ่มต้น ─────────────
  const firstItem = document.querySelector('.visit-item');
  if (firstItem) {
    firstItem.classList.add('active');
    updateDetails(firstItem.dataset.visitId);
  } else {
    detailContent.innerHTML = '<div class="text-muted text-center p-4">ไม่มีข้อมูลการรักษา</div>';
  }
});
</script>
</body>
</html>