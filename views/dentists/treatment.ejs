<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>บันทึกการรักษา - <%= patient.first_name %></title>

  <!-- CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/public/css/main.css"/>
  <link rel="stylesheet" href="/public/css/visit-form.css"/>
</head>

<body>
  <div class="container my-4">
    <form action="/dentist/treatment" method="POST" enctype="multipart/form-data" id="visit-form">
      <input type="hidden" name="patient_id" value="<%= patient.id %>"/>
      <input type="hidden" name="procedures" id="procedures-input"/>
      <input type="file" id="xray-files-input" name="xrays" multiple style="display:none;"/>

      <div class="row">
        <!-- Left -->
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">ข้อมูลผู้ป่วยและการเข้าพบ</div>
            <div class="card-body">
              <div class="patient-info-display">
                <p><strong>ชื่อ-นามสกุล:</strong> <%= patient.first_name %> <%= patient.last_name %></p>
                <p><strong>อายุ:</strong> <%= patient.age %></p>
                <p><strong>เพศ:</strong> <%= patient.gender %></p>
                <p><strong>CN:</strong> <%= patient.clinic_number %></p>
              </div>
              <a href="/dentist/patients/<%= patient.id %>/history" class="btn btn-sm btn-outline-primary mt-2">ดูประวัติการรักษา</a>
              <hr class="my-4"/>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label for="visit_date">วันที่</label>
                  <input type="datetime-local" class="form-control" id="visit_date" name="visit_date" required/>
                </div>
                <div class="form-group col-md-6">
                  <label for="doctor_name">แพทย์</label>
                  <input type="text" class="form-control" id="doctor_name" name="doctor_name" value="<%= doctor_name %>" readonly/>
                </div>

                <div class="form-group col-md-6">
                  <label>Blood Pressure (SYS/DIA)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" name="bp_sys" placeholder="Systolic"/>
                    <input type="number" class="form-control" name="bp_dia" placeholder="Diastolic"/>
                  </div>
                </div>

                <div class="form-group col-md-6">
                  <label for="pulse_rate">Pulse Rate</label>
                  <input type="number" class="form-control" id="pulse_rate" name="pulse_rate" placeholder="bpm"/>
                </div>
              </div>

              <div class="form-group">
                <label for="clinical_notes">Clinical Notes</label>
                <textarea class="form-control" name="clinical_notes" id="clinical_notes" rows="3" placeholder="บันทึกรายละเอียดอาการ / ข้อวินิจฉัย / การตรวจ"></textarea>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">หัตถการและการรักษา</div>
            <div class="card-body">
              <div class="procedure-quick-select">
                <% procedure_codes.forEach(code => { %>
                  <button type="button" class="quick-add-proc"
                          data-code="<%= code.code %>"
                          data-desc="<%= code.description %>"
                          data-price="<%= code.price %>"><%= code.description %></button>
                <% }); %>
                <!-- ตัวอย่างปุ่มเสริม -->
                <button type="button" class="quick-add-proc" data-code="EXT" data-desc="ถอนฟัน" data-price="900">ถอนฟัน</button>
                <button type="button" class="quick-add-proc" data-code="SURG-EXT" data-desc="ผ่าฟันคุด" data-price="2500">ผ่าฟันคุด</button>
                <button type="button" class="quick-add-proc" data-code="CROWN" data-desc="ครอบฟัน" data-price="8000">ครอบฟัน</button>
                <button type="button" class="quick-add-proc" data-code="BLEACH" data-desc="ฟอกสีฟัน" data-price="3500">ฟอกสีฟัน</button>
                <button type="button" class="quick-add-proc" data-code="XRAY-SM" data-desc="เอ็กซเรย์ฟิล์มเล็ก" data-price="300">เอ็กซเรย์</button>
              </div>

              <div class="custom-procedure-adder">
                <input type="text" id="custom-proc-desc" class="form-control" placeholder="เพิ่มรายการอื่น ๆ"/>
                <input type="number" id="custom-proc-price" class="form-control" placeholder="ราคา"/>
                <button type="button" id="add-custom-proc-btn" class="btn btn-info">เพิ่ม</button>
              </div>

              <hr/>

              <div id="teeth-helper" class="teeth-helper alert alert-info" style="display:none;"></div>

              <h6 class="mb-2">ซี่ฟันที่รักษา (เลือกหลายซี่ได้)</h6>
              <div class="tooth-chart-container mt-3" id="tooth-chart">
                <div class="tooth-type-toggle">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="tooth-type" id="adult-teeth-radio" value="adult" checked/>
                    <label class="form-check-label" for="adult-teeth-radio">ฟันแท้ (11-48)</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="tooth-type" id="child-teeth-radio" value="child"/>
                    <label class="form-check-label" for="child-teeth-radio">ฟันน้ำนม (51-85)</label>
                  </div>
                </div>

                <div id="teeth-disabled-overlay" class="teeth-disabled" style="display:none;">
                  <div>เลือกแถวหัตถการที่ “ต่อซี่” ก่อน แล้วคลิกซี่ฟันที่นี่</div>
                </div>

                <div class="adult-teeth">
                  <div class="tooth-row"><% for (let i=11;i<=18;i++){ %><div class="tooth" data-tooth-id="<%= i %>"><%= i %></div><% } %></div>
                  <div class="tooth-row"><% for (let i=21;i<=28;i++){ %><div class="tooth" data-tooth-id="<%= i %>"><%= i %></div><% } %></div>
                  <div class="tooth-row"><% for (let i=31;i<=38;i++){ %><div class="tooth" data-tooth-id="<%= i %>"><%= i %></div><% } %></div>
                  <div class="tooth-row"><% for (let i=41;i<=48;i++){ %><div class="tooth" data-tooth-id="<%= i %>"><%= i %></div><% } %></div>
                </div>
                <div class="child-teeth">
                  <div class="tooth-row"><% for (let i=51;i<=55;i++){ %><div class="tooth" data-tooth-id="<%= i %>"><%= i %></div><% } %></div>
                  <div class="tooth-row"><% for (let i=61;i<=65;i++){ %><div class="tooth" data-tooth-id="<%= i %>"><%= i %></div><% } %></div>
                  <div class="tooth-row"><% for (let i=71;i<=75;i++){ %><div class="tooth" data-tooth-id="<%= i %>"><%= i %></div><% } %></div>
                  <div class="tooth-row"><% for (let i=81;i<=85;i++){ %><div class="tooth" data-tooth-id="<%= i %>"><%= i %></div><% } %></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">ไฟล์แนบ / X-Ray</div>
            <div class="card-body">
              <div id="file-drop-area" class="file-drop-area">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                <p>ลากและวางไฟล์ที่นี่ หรือคลิกเพื่อเลือกไฟล์</p>
              </div>
              <div id="file-list-display" class="mt-3"></div>
            </div>
          </div>
        </div>

        <!-- Right -->
        <div class="col-lg-4">
          <div class="treatment-summary-section">
            <div class="card">
              <div class="card-header">สรุปค่าใช้จ่าย</div>
              <div class="card-body" style="padding:0;">
                <table class="treatment-list-table">
                  <thead>
                    <tr>
                      <th>รายการ</th>
                      <th style="width:90px;">จำนวน</th>
                      <th style="width:140px;">ราคา</th>
                      <th style="width:40px;"></th>
                    </tr>
                  </thead>
                  <tbody id="treatment-list-body">
                    <tr><td colspan="4" class="text-center text-muted p-4">ยังไม่มีรายการ</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="card-footer">
                <table class="cost-summary-table">
                  <tbody>
                    <tr><td class="label">ยอดรวม</td><td class="value" id="subtotal">฿0.00</td></tr>
                    <tr>
                      <td class="total-label">ยอดสุทธิ</td>
                      <td class="total-value" id="total-amount">฿0.00</td>
                      <input type="hidden" name="amount" id="amount-input"/>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mt-4">
              <button type="submit" class="btn btn-primary btn-block btn-lg">บันทึกการรักษา</button>
              <a href="/dentist/patients" class="btn btn-secondary btn-block">ยกเลิก</a>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!-- App JS (ภายนอก) -->
  <script src="/public/js/treatment.js"></script>
</body>
</html>
