<!DOCTYPE html>
<html lang="th">
<head>
  <%- include('../partials/head') %>
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</title>
  <link rel="stylesheet" href="/public/css/patient_dashboard.css">
</head>
<body>
  <div class="app">
    <%- include('../partials/navbar', { user: user, userRole: userRole, page: 'dashboard' }) %>

    <main class="main-content">
      <div class="dashboard-header">
        <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h1>
      </div>

      <div class="dashboard-grid">
        <!-- ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ -->
        <div class="card appointment-card">
          <div class="card-header">
            <h2>‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</h2>
            <a href="/patient/patient_appointment" class="btn btn-primary btn-sm">‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</a>
          </div>
          
          <% if (appointment) { %>
            <div class="appointment-details">
              <% 
                const start = new Date(appointment.start_time);
                const end = new Date(appointment.end_time);
                const dateTh = start.toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric' });
                const timeRange = `${start.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}`;
                const statusMap = {
                  'pending': '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                  'confirmed': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                  'checked_in': '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                  'done': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                  'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                  'no_show': '‡πÑ‡∏°‡πà‡∏°‡∏≤',
                  'NEW': '‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß',
                  'PENDING': '‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß'
                };
                const statusText = statusMap[appointment.status] || appointment.status;
                const statusClass = appointment.status.toLowerCase();
              %>
              
              <% if (appointment.is_request) { %>
                <div class="info-badge">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÇ‡∏î‡∏¢‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å)</div>
              <% } %>
              
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
                  <span class="value"><%= dateTh %></span>
                </div>
                <div class="detail-item">
                  <span class="label">‡πÄ‡∏ß‡∏•‡∏≤:</span>
                  <span class="value"><%= timeRange %></span>
                </div>
                <div class="detail-item">
                  <span class="label">‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå:</span>
                  <span class="value"><%= appointment.dentist_name || (appointment.is_request ? '‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') %></span>
                </div>
                <div class="detail-item">
                  <span class="label">‡∏¢‡∏π‡∏ô‡∏¥‡∏ï/‡∏´‡πâ‡∏≠‡∏á:</span>
                  <span class="value"><%= appointment.unit_name || (appointment.is_request ? '‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß' : '-') %></span>
                </div>
                <div class="detail-item">
                  <span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                  <span class="status-chip <%= statusClass %>"><%= statusText %></span>
                </div>
                <% if (appointment.notes) { %>
                <div class="detail-item full-width">
                  <span class="label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span>
                  <span class="value"><%= appointment.notes %></span>
                </div>
                <% } %>
              </div>
            </div>
          <% } else { %>
            <div class="empty-state">
              <div class="empty-icon">üìÖ</div>
              <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>
              <a href="/patient/patient_appointment" class="btn btn-primary">‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡∏à‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</a>
            </div>
          <% } %>
        </div>

        <!-- ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
        <div class="card payment-card">
          <div class="card-header">
            <h2>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
            <a href="/patient/payments" class="btn btn-outline btn-sm">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
          </div>
          
          <% if (payment) { %>
            <div class="payment-details">
              <div class="payment-amount">
                <span class="amount"><%= Number(payment.amount).toLocaleString('th-TH', { minimumFractionDigits: 2 }) %></span>
                <span class="currency">‡∏ö‡∏≤‡∏ó</span>
              </div>
              <div class="payment-status <%= payment.status %>">
                <%= payment.status === 'pending' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' %>
              </div>
              <div class="payment-date">
                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <%= payment.payment_date ? new Date(payment.payment_date).toLocaleDateString('th-TH') : '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞' %>
              </div>
              <% if (payment.status === 'pending') { %>
                <a href="/patient/payments" class="btn btn-primary btn-pay">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô now</a>
              <% } %>
            </div>
          <% } else { %>
            <div class="empty-state">
              <div class="empty-icon">üí≥</div>
              <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
              <a href="/patient/payments" class="btn btn-outline">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</a>
            </div>
          <% } %>
        </div>

        <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
        <div class="card history-card">
          <div class="card-header">
            <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="recentAppointments">
                <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
              </tbody>
            </table>
            <div class="loading-state" id="loadingAppointments">
              <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            <div class="empty-state" id="emptyAppointments" style="display:none;">
              <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>
            </div>
          </div>
        </div>

        
      </div>
    </main>
  </div>

  <!-- Modal ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î -->
  <div class="modal" id="rescheduleModal" aria-hidden="true">
    <div class="modal-content">
      <h3>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3>
      <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏±‡∏î‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏î‡∏¥‡∏°</p>
      
      <form id="rescheduleForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="rsDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà *</label>
            <input type="date" id="rsDate" name="rsDate" required 
                   min="<%= new Date().toISOString().split('T')[0] %>">
          </div>
          <div class="form-group">
            <label for="rsSlot">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ *</label>
            <select id="rsSlot" name="rsSlot" required>
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ --</option>
              <option value="10:00-11:00">10:00-11:00</option>
              <option value="11:00-12:00">11:00-12:00</option>
              <option value="12:00-13:00">12:00-13:00</option>
              <option value="13:00-14:00">13:00-14:00</option>
              <option value="14:00-15:00">14:00-15:00</option>
              <option value="15:00-16:00">15:00-16:00</option>
              <option value="16:00-17:00">16:00-17:00</option>
              <option value="17:00-18:00">17:00-18:00</option>
              <option value="18:00-19:00">18:00-19:00</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label for="rsNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <textarea id="rsNote" name="rsNote" rows="3" 
                      placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô..."></textarea>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="btnRsCancel">‡∏õ‡∏¥‡∏î</button>
          <button type="submit" class="btn btn-primary" id="btnRsSubmit">
            <span class="btn-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</span>
            <span class="btn-loading" style="display:none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="/public/js/patient_dashboard.js"></script>
</body>
</html>