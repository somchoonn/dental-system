<%- include('../partials/head', { userRole: userRole }) %>
<body>
  <div class="app">
    <%- include('../partials/navbar', { userRole: userRole }) %>

    <main class="main">
      <% if (successMessage) { %>
        <div class="alert alert-success" id="success-alert">
          <%= successMessage %>
          <button type="button" class="close" onclick="document.getElementById('success-alert').style.display='none'">&times;</button>
        </div>
      <% } %>

      <div class="toolbar">
        <form class="search" role="search" method="GET" action="/staff/patients">
          <input type="hidden" name="pageSize" value="<%= pageSize %>"/>
          <input type="search" name="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠/‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å" aria-label="Search" value="<%= searchQuery %>" />
          <button type="submit" style="background:none; border:none; cursor:pointer;">
            üîé
          </button>
        </form>
        <div class="spacer"></div>
        
      </div>

      <section class="card" aria-label="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
        <!-- ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (sticky) -->
        <header class="table-head">
          <div>CLINIC NUMBER</div>
          <div>‡∏ä‡∏∑‡πà‡∏≠</div>
          <div>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
          <div>‡∏≠‡∏≤‡∏¢‡∏∏</div>
          <div>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div>
          <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
          <div>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
        </header>

        <!-- ‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏Å‡∏£‡∏≠‡∏•‡πÑ‡∏î‡πâ -->
        <div class="table-body">
          <% if (!patients.length) { %>
            <div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
          <% } %>
          <% patients.forEach(p => { %>
            <div class="row">
              <div><%= p.clinic_number %></div>
              <div><%= p.first_name %></div>
              <div><%= p.last_name %></div>
              <div><%= p.age %></div>
              <div><%= p.phone %></div>
              <div><%= p.created_at %></div>
              <div><a class="chip chip-edit" href="/staff/patients/<%= p.id %>/edit">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a></div>
            </div>
          <% }) %>
        </div>
      </section>

      <% if (totalPages > 1) { 
          const windowSize = 7; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå
          const half = Math.floor(windowSize/2);
          let start = Math.max(1, page - half);
          let end = Math.min(totalPages, start + windowSize - 1);
          start = Math.max(1, Math.min(start, end - windowSize + 1));
      %>
        <nav class="pager" aria-label="Pagination">
          <!-- ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ -->
          <% if (page > 1) { %>
            <a class="pager-btn" href="?page=<%= page-1 %>&pageSize=<%= pageSize %>&search=<%= encodeURIComponent(searchQuery) %>">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
          <% } else { %>
            <span class="pager-btn disabled">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span>
          <% } %>

          <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å + ellipsis -->
          <% if (start > 1) { %>
            <a class="pager-num" href="?page=1&pageSize=<%= pageSize %>&search=<%= encodeURIComponent(searchQuery) %>">1</a>
            <% if (start > 2) { %><span class="pager-ellipsis">‚Ä¶</span><% } %>
          <% } %>

          <!-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á -->
          <% for (let i = start; i <= end; i++) { %>
            <a class="pager-num <%= i === page ? 'active' : '' %>" href="?page=<%= i %>&pageSize=<%= pageSize %>&search=<%= encodeURIComponent(searchQuery) %>"><%= i %></a>
          <% } %>

          <!-- ellipsis + ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ -->
          <% if (end < totalPages) { %>
            <% if (end < totalPages-1) { %><span class="pager-ellipsis">‚Ä¶</span><% } %>
            <a class="pager-num" href="?page=<%= totalPages %>&pageSize=<%= pageSize %>&search=<%= encodeURIComponent(searchQuery) %>"><%= totalPages %></a>
          <% } %>

          <!-- ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ -->
          <% if (page < totalPages) { %>
            <a class="pager-btn" href="?page=<%= page+1 %>&pageSize=<%= pageSize %>&search=<%= encodeURIComponent(searchQuery) %>">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>
          <% } else { %>
            <span class="pager-btn disabled">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
          <% } %>
        </nav>

        <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß/‡∏´‡∏ô‡πâ‡∏≤ -->
        <form class="page-size-form" method="GET" action="/staff/patients">
          <input type="hidden" name="search" value="<%= searchQuery %>" />
          <label>‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</label>
          <select name="pageSize" onchange="this.form.submit()">
            <% [10,15,20,30,50].forEach(n => { %>
              <option value="<%= n %>" <%= pageSize===n ? 'selected' : '' %>><%= n %></option>
            <% }) %>
          </select>
          <span class="muted">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= total %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </form>
      <% } %>
    </main>
  </div>
</body>
</html>
